<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head th:replace="layout/layoutSamu :: head">
    <meta charset="UTF-8">
    <title>[[${title}]]</title>
    <!-- Se asume que Tailwind ya se carga en tu layout -->
</head>
<body class="bg-gray-100 text-gray-800">

<!-- Sidebar fijo -->
<div th:replace="layout/layoutSamu :: sidebar"></div>

<div class="ml-64 p-8 min-h-screen">
    <!-- Header -->
    <div th:replace="layout/layoutSamu :: header"></div>

    <!-- Contenedor principal -->
    <div class="max-w-md mx-auto mt-24 mb-12 bg-white rounded-2xl shadow-lg overflow-hidden">
        <!-- Encabezado púrpura -->
        <div class="bg-purple-700 px-6 py-5">
            <h1 class="text-center text-2xl font-bold text-white">
                Crear Usuario
            </h1>
        </div>

        <!-- Formulario -->
        <form th:action="@{/crearUsuario}"
              method="post"
              enctype="multipart/form-data"
              th:object="${usuario}"
              class="px-8 py-8 space-y-6">

            <!-- 1) Nombre -->
            <div class="relative">
                <label for="nombre_usu" class="block text-gray-700 font-semibold mb-2">
                    Nombre
                </label>
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400 pointer-events-none">
            <!-- Icono usuario -->
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="h-5 w-5"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke="currentColor"
                 stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M5.121 17.804A9 9 0 0112 15a9 9 0 016.879 2.804M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </span>
                <input type="text"
                       id="nombre_usu"
                       th:field="*{nombre_usu}"
                       required
                       class="appearance-none h-10 w-full pl-10 pr-4 border border-gray-300 rounded-lg bg-white
                        focus:outline-none focus:ring-2 focus:ring-purple-500 transition" />
            </div>

            <!-- 2) Apellido -->
            <div class="relative">
                <label for="apellido_usu" class="block text-gray-700 font-semibold mb-2">
                    Apellido
                </label>
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400 pointer-events-none">
            <!-- Icono usuario -->
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="h-5 w-5"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke="currentColor"
                 stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M5.121 17.804A9 9 0 0112 15a9 9 0 016.879 2.804M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </span>
                <input type="text"
                       id="apellido_usu"
                       th:field="*{apellido_usu}"
                       required
                       class="appearance-none h-10 w-full pl-10 pr-4 border border-gray-300 rounded-lg bg-white
                        focus:outline-none focus:ring-2 focus:ring-purple-500 transition" />
            </div>

            <!-- 3) Contraseña -->
            <div class="relative">
                <label for="clave" class="block text-gray-700 font-semibold mb-2">
                    Contraseña
                </label>
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400 pointer-events-none">
            <!-- Icono candado -->
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="h-5 w-5"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke="currentColor"
                 stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M12 11c.552 0 1 .448 1 1v1h-2v-1c0-.552.448-1 1-1zm-6 2V8a6 6 0 1112 0v5m-9 4h6a2 2 0 012 2v1H5v-1a2 2 0 012-2z"/>
            </svg>
          </span>
                <input type="password"
                       id="clave"
                       th:field="*{clave}"
                       required
                       class="appearance-none h-10 w-full pl-10 pr-4 border border-gray-300 rounded-lg bg-white
                        focus:outline-none focus:ring-2 focus:ring-purple-500 transition" />
            </div>

            <!-- 4) Email -->
            <div class="relative">
                <label for="email" class="block text-gray-700 font-semibold mb-2">
                    Email
                </label>
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400 pointer-events-none">
            <!-- Icono correo -->
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="h-5 w-5"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke="currentColor"
                 stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M16 12H8m8 0l-4-4m4 4l-4 4m-4 0c1.105 0 2 .895 2 2v1a2 2 0 01-2 2H5a2 2 0 01-2-2v-1c0-1.105.895-2 2-2zm14 0c1.105 0 2 .895 2 2v1a2 2 0 01-2 2h-3a2 2 0 01-2-2v-1c0-1.105.895-2 2-2z" />
            </svg>
          </span>
                <input type="email"
                       id="email"
                       th:field="*{email}"
                       required
                       class="appearance-none h-10 w-full pl-10 pr-4 border border-gray-300 rounded-lg bg-white
                        focus:outline-none focus:ring-2 focus:ring-purple-500 transition" />
            </div>

            <!-- 5) Ciudad -->
            <div class="relative">
                <label for="ciudad" class="block text-gray-700 font-semibold mb-2">
                    Ciudad
                </label>
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400 pointer-events-none">
            <!-- Icono mapa -->
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="h-5 w-5"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke="currentColor"
                 stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M9 20l-5.447-2.724A2 2 0 013 15.382V5.618a2 2 0 011.553-1.942L9 2m0 18l6-3V2l-6 3v15zm6 0l5.447-2.724A2 2 0 0021 15.382V5.618a2 2 0 00-1.553-1.942L15 2" />
            </svg>
          </span>
                <input type="text"
                       id="ciudad"
                       th:field="*{ciudad}"
                       required
                       class="appearance-none h-10 w-full pl-10 pr-4 border border-gray-300 rounded-lg bg-white
                        focus:outline-none focus:ring-2 focus:ring-purple-500 transition" />
            </div>

            <!-- 6) Teléfono -->
            <div class="relative">
                <label for="telefono" class="block text-gray-700 font-semibold mb-2">
                    Teléfono
                </label>
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400 pointer-events-none">
            <!-- Icono teléfono -->
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="h-5 w-5"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke="currentColor"
                 stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M3 5h2l3.5 7a1 1 0 01-.9 1.5H5l5 9a1 1 0 001.7 0L17 4h2" />
            </svg>
          </span>
                <input type="text"
                       id="telefono"
                       th:field="*{telefono}"
                       class="appearance-none h-10 w-full pl-10 pr-4 border border-gray-300 rounded-lg bg-white
                        focus:outline-none focus:ring-2 focus:ring-purple-500 transition" />
            </div>

            <!-- 7) Foto de perfil -->
            <div class="flex flex-col">
                <label class="text-gray-700 font-semibold mb-2">
                    Foto de Perfil
                </label>
                <input type="file"
                       id="archivofoto"
                       name="archivofoto"
                       accept="image/*"
                       class="hidden"
                       onchange="updatePreview(this)" />
                <label for="archivofoto"
                       class="inline-flex items-center gap-2 bg-indigo-500 text-white px-4 py-2 rounded-md
                        hover:bg-indigo-600 transform hover:scale-105 transition-all cursor-pointer">
                    <!-- Icono cámara -->
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-5 w-5"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor"
                         stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M3 7h2l2-3h10l2 3h2a2 2 0 012 2v10a2 2 0 01-2 2H3a2 2 0 01-2-2V9a2 2 0 012-2z" />
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M12 11a3 3 0 100 6 3 3 0 000-6z" />
                    </svg>
                    Seleccionar Foto
                </label>
                <span id="file-name"
                      class="mt-2 text-sm text-gray-600 truncate max-w-full">
            Ningún archivo
          </span>

                <!-- Vista previa recortada -->
                <div class="flex justify-center mt-4">
                    <img id="preview"
                         alt="Preview"
                         class="w-48 h-48 object-cover rounded-xl border-4 border-gray-300 shadow-lg bg-white/70 hidden" />
                </div>
            </div>

            <!-- 8) Rol (select) -->
            <div class="relative">
                <label for="idRol" class="block text-gray-700 font-semibold mb-2">
                    Rol
                </label>
                <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400 pointer-events-none">
            <!-- Icono escudo -->
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="h-5 w-5"
                 fill="none"
                 viewBox="0 0 24 24"
                 stroke="currentColor"
                 stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M12 2l9 4v6c0 5-3.6 9.9-9 10-5.4-.1-9-5-9-10V6l9-4z" />
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M12 11v5m0 0l3-3m-3 3l-3-3" />
            </svg>
          </span>
                <select id="idRol"
                        th:field="*{idRol.idRol}"
                        required
                        class="block w-full h-10 pl-10 pr-4 border border-gray-300 rounded-lg bg-white
                         focus:outline-none focus:ring-2 focus:ring-purple-500 transition">
                    <option value="">-- Seleccione un rol --</option>
                    <option th:each="rol : ${roles}"
                            th:value="${rol.idRol}"
                            th:text="${rol.rol}">
                    </option>
                </select>
            </div>

            <!-- Botón “Crear Usuario” -->
            <div class="flex justify-end">
                <button type="submit"
                        class="flex items-center gap-2 bg-green-500 hover:bg-green-600 text-white font-semibold
                         px-6 py-2 rounded-lg shadow transform hover:scale-105 transition-all">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         class="h-5 w-5"
                         fill="none"
                         viewBox="0 0 24 24"
                         stroke="currentColor"
                         stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                              d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-5-5l5 5m0 0l-5 5m5-5H9" />
                    </svg>
                    Crear Usuario
                </button>
            </div>

        </form>
    </div>
</div>

<!-- Script para recortar la imagen y actualizar la previsualización -->
<script>
    const inputFoto = document.getElementById("archivofoto");
    const preview = document.getElementById("preview");
    const fileNameLabel = document.getElementById("file-name");

    function updatePreview(input) {
        if (!input.files || input.files.length === 0) {
            preview.src = "#";
            preview.classList.add("hidden");
            fileNameLabel.textContent = "Ningún archivo";
            return;
        }
        const file = input.files[0];
        fileNameLabel.textContent = file.name;

        if (!file.type.startsWith("image/")) {
            preview.src = "#";
            preview.classList.add("hidden");
            return;
        }

        const reader = new FileReader();
        reader.onload = ev => {
            const img = new Image();
            img.onload = () => {
                const SIZE = 200;
                const canvas = document.createElement("canvas");
                canvas.width = SIZE;
                canvas.height = SIZE;
                const ctx = canvas.getContext("2d");

                // Calcular ratio para centrar la imagen
                const ratio = Math.min(SIZE / img.width, SIZE / img.height);
                const w = img.width * ratio;
                const h = img.height * ratio;
                const x = (SIZE - w) / 2;
                const y = (SIZE - h) / 2;
                ctx.drawImage(img, x, y, w, h);

                preview.src = canvas.toDataURL("image/png");
                preview.classList.remove("hidden");

                // Reemplazar el archivo original por el recortado
                canvas.toBlob(blob => {
                    const newFile = new File([blob], file.name, { type: "image/png" });
                    const dt = new DataTransfer();
                    dt.items.add(newFile);
                    input.files = dt.files;
                }, "image/png");
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
    }

    // Agregar listener
    if (inputFoto) {
        inputFoto.addEventListener("change", () => updatePreview(inputFoto));
    }
</script>

</body>
</html>
